import React, { useEffect, useState } from 'react';
import { GestureHandlerRootView } from 'react-native-gesture-handler';
import MainLayout from './components/navigation/MainLayout';
import { ShowListProvider } from './context/ShowListContext';
import { VocabularyProvider } from './context/VocabularyContext';
import { AuthProvider } from './context/AuthContext';
import { LanguageProvider } from './context/LanguageContext';
import { AppLanguageProvider } from './context/AppLanguageContext';
import { Audio } from 'expo-av';
import { InterruptionModeIOS, InterruptionModeAndroid } from 'expo-av/build/Audio.types';
import { InitialLanguageModal } from './components/common/InitialLanguageModal';
import { ReauthModal } from './components/auth/ReauthModal';
import AsyncStorage from '@react-native-async-storage/async-storage';
import * as Device from 'expo-device';
import { unifiedSyncService } from './services/unifiedSyncService';
import { experienceManager } from './services/experienceManager';
import { guestModeService } from './services/guestModeService';
import { tokenValidationService } from './services/tokenValidationService';

// å†…éƒ¨ç»„ä»¶ï¼šç§»é™¤è‡ªåŠ¨é€šçŸ¥åˆå§‹åŒ–
const AppContent = () => {
  const [showInitialLanguageModal, setShowInitialLanguageModal] = useState(false);
  const [showReauthModal, setShowReauthModal] = useState(false);
  const [reauthReason, setReauthReason] = useState('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');

  useEffect(() => {
    initializeApp();
  }, []);

  const initializeApp = async () => {
    try {
      console.log('ğŸš€ åº”ç”¨åˆå§‹åŒ–å¼€å§‹...');
      
      // 1. æ£€æŸ¥åˆå§‹è¯­è¨€è®¾ç½®
      await checkInitialLanguageSetup();
      
      // 2. æ¸…ç†å¯èƒ½çš„å…±äº«æ•°æ®
      await clearSharedDataOnStartup();
      
      // 3. è‡ªåŠ¨ç”Ÿæˆæ¸¸å®¢ID
      await autoGenerateGuestId();
      
      // 4. åˆå§‹åŒ–ç»Ÿä¸€åŒæ­¥æœåŠ¡
      await initializeUnifiedSync();
      
      // 5. åˆå§‹åŒ–ç»éªŒå€¼ç®¡ç†å™¨
      await initializeExperienceManager();
      
      // 6. è®¾ç½®é‡æ–°è®¤è¯å›è°ƒ
      setupReauthCallback();
      
      console.log('âœ… åº”ç”¨åˆå§‹åŒ–å®Œæˆ');
    } catch (error) {
      console.error('âŒ åº”ç”¨åˆå§‹åŒ–å¤±è´¥:', error);
    }
  };

  const initializeUnifiedSync = async () => {
    try {
      console.log('ğŸ”„ åˆå§‹åŒ–ç»Ÿä¸€åŒæ­¥æœåŠ¡...');
      
      // è¿ç§»æ—§åŒæ­¥æ•°æ®
      await unifiedSyncService.migrateOldSyncData();
      
      // é…ç½®åŒæ­¥æœåŠ¡
      unifiedSyncService.updateConfig({
        wifiSyncInterval: 2 * 60 * 1000, // 2åˆ†é’Ÿ
        mobileSyncInterval: 5 * 60 * 1000, // 5åˆ†é’Ÿ
        enableRealTimeSync: true,
        enableOfflineFirst: true
      });
      
      console.log('âœ… ç»Ÿä¸€åŒæ­¥æœåŠ¡åˆå§‹åŒ–å®Œæˆ');
    } catch (error) {
      console.error('âŒ ç»Ÿä¸€åŒæ­¥æœåŠ¡åˆå§‹åŒ–å¤±è´¥:', error);
    }
  };

  const initializeExperienceManager = async () => {
    try {
      console.log('â­ åˆå§‹åŒ–ç»éªŒå€¼ç®¡ç†å™¨...');
      
      // é…ç½®ç»éªŒå€¼ç®¡ç†å™¨
      experienceManager.updateConfig({
        enableAnimations: true,
        enableNotifications: true,
        enableSound: true,
        autoSync: true
      });
      
      console.log('âœ… ç»éªŒå€¼ç®¡ç†å™¨åˆå§‹åŒ–å®Œæˆ');
    } catch (error) {
      console.error('âŒ ç»éªŒå€¼ç®¡ç†å™¨åˆå§‹åŒ–å¤±è´¥:', error);
    }
  };

  const checkInitialLanguageSetup = async () => {
    try {
      const hasSetup = await AsyncStorage.getItem('initialLanguageSetup');
      if (!hasSetup) {
        setShowInitialLanguageModal(true);
      }
    } catch (error) {
      console.error('æ£€æŸ¥åˆå§‹è¯­è¨€è®¾ç½®å¤±è´¥:', error);
      setShowInitialLanguageModal(true);
    }
  };

  const clearSharedDataOnStartup = async () => {
    try {
      console.log('ğŸš€ åº”ç”¨å¯åŠ¨æ—¶æ¸…ç†å…±äº«æ•°æ®...');
      
      // æ£€æŸ¥æ˜¯å¦æœ‰ç”¨æˆ·æ•°æ®
      const userData = await AsyncStorage.getItem('userData');
      if (!userData) {
        // å¦‚æœæ²¡æœ‰ç”¨æˆ·æ•°æ®ï¼Œæ¸…ç†å¯èƒ½å­˜åœ¨çš„å…±äº«æ•°æ®
        const keysToRemove = [
          'searchHistory',
          'vocabulary',
          'learningRecords',
          'userStats',
          'badges'
        ];
        
        await AsyncStorage.multiRemove(keysToRemove);
        console.log('âœ… å¯åŠ¨æ—¶å…±äº«æ•°æ®æ¸…ç†å®Œæˆ');
      }
    } catch (error) {
      console.error('âŒ å¯åŠ¨æ—¶æ¸…ç†å…±äº«æ•°æ®å¤±è´¥:', error);
    }
  };

  // è‡ªåŠ¨ç”Ÿæˆæ¸¸å®¢ç”¨æˆ·ID
  const autoGenerateGuestId = async () => {
    try {
      console.log('ğŸ” æ£€æŸ¥æ˜¯å¦éœ€è¦è‡ªåŠ¨ç”Ÿæˆæ¸¸å®¢ID...');
      
      // æ£€æŸ¥æ˜¯å¦å·²æœ‰ç”¨æˆ·æ•°æ®
      const userData = await AsyncStorage.getItem('userData');
      if (userData) {
        console.log('âœ… ç”¨æˆ·æ•°æ®å·²å­˜åœ¨ï¼Œè·³è¿‡è‡ªåŠ¨ç”Ÿæˆ');
        return;
      }

      // æ£€æŸ¥æ˜¯å¦å·²è®¾ç½®è¿‡è‡ªåŠ¨ç”Ÿæˆæ ‡è®°
      const hasAutoGenerated = await AsyncStorage.getItem('autoGeneratedGuestId');
      if (hasAutoGenerated) {
        console.log('âœ… å·²è‡ªåŠ¨ç”Ÿæˆè¿‡æ¸¸å®¢IDï¼Œè·³è¿‡');
        return;
      }

      console.log('ğŸš€ å¼€å§‹è‡ªåŠ¨ç”Ÿæˆæ¸¸å®¢ID...');
      
      // ç”Ÿæˆå”¯ä¸€çš„æ¸¸å®¢ID
      const now = Date.now().toString();
      const random = Math.random().toString(36).substr(2, 4);
      const deviceId = Device.deviceName || Device.modelName || 'unknown';
      const deviceHash = deviceId.split('').reduce((a, b) => a + b.charCodeAt(0), 0).toString(36).slice(-3);
      const guestId = now.slice(-6) + random + deviceHash;
      
      console.log('ğŸ”„ æ­£åœ¨ä¸ºæ¸¸å®¢IDè·å–JWTä»¤ç‰Œ...');
      
      // è°ƒç”¨åç«¯APIæ³¨å†Œæ¸¸å®¢ç”¨æˆ·å¹¶è·å–JWTä»¤ç‰Œ
      try {
        const registerData = {
          loginType: 'guest',
          username: `t_guest_${guestId}`.slice(0, 20),
          nickname: guestId,
          guestId: guestId,
        };

        const response = await fetch('https://dramawordv2.onrender.com/api/users/register', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(registerData),
        });

        if (response.ok) {
          const result = await response.json();
          console.log('âœ… æ¸¸å®¢æ³¨å†ŒæˆåŠŸï¼Œè·å¾—JWTä»¤ç‰Œ');
          
          // ä¿å­˜å®Œæ•´çš„ç”¨æˆ·æ•°æ®ï¼ˆåŒ…å«JWTä»¤ç‰Œï¼‰
          const completeUserData = {
            id: result.data.user.id,
            nickname: result.data.user.nickname,
            loginType: 'guest',
            token: result.data.token, // ç°åœ¨æœ‰äº†çœŸæ­£çš„JWTä»¤ç‰Œ
            isAutoGenerated: true
          };

          await AsyncStorage.setItem('userData', JSON.stringify(completeUserData));
          await AsyncStorage.setItem('autoGeneratedGuestId', 'true');
          
          console.log('âœ… è‡ªåŠ¨ç”Ÿæˆæ¸¸å®¢IDå¹¶è·å–ä»¤ç‰ŒæˆåŠŸ:', guestId);
        } else {
          console.warn('âš ï¸ æ¸¸å®¢æ³¨å†Œå¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°IDæ¨¡å¼');
          // å¦‚æœæ³¨å†Œå¤±è´¥ï¼Œä»ç„¶ä¿å­˜æœ¬åœ°IDï¼ˆæ— ä»¤ç‰Œæ¨¡å¼ï¼‰
          const tempUserData = {
            id: guestId,
            nickname: guestId,
            loginType: 'guest',
            token: null,
            isAutoGenerated: true,
            createdAt: Date.now(),
            localDataVersion: 1
          };

          await AsyncStorage.setItem('userData', JSON.stringify(tempUserData));
          await AsyncStorage.setItem('autoGeneratedGuestId', 'true');
          
          // åˆå§‹åŒ–æ¸¸å®¢æ¨¡å¼æœåŠ¡
          await guestModeService.isGuestMode();
        }
      } catch (error) {
        console.warn('âš ï¸ ç½‘ç»œé”™è¯¯ï¼Œä½¿ç”¨æœ¬åœ°IDæ¨¡å¼:', error);
        // ç½‘ç»œé”™è¯¯æ—¶ï¼Œä»ç„¶ä¿å­˜æœ¬åœ°IDï¼ˆæ— ä»¤ç‰Œæ¨¡å¼ï¼‰
        const tempUserData = {
          id: guestId,
          nickname: guestId,
          loginType: 'guest',
          token: null,
          isAutoGenerated: true,
          createdAt: Date.now(),
          localDataVersion: 1
        };

        await AsyncStorage.setItem('userData', JSON.stringify(tempUserData));
        await AsyncStorage.setItem('autoGeneratedGuestId', 'true');
        
        // åˆå§‹åŒ–æ¸¸å®¢æ¨¡å¼æœåŠ¡
        await guestModeService.isGuestMode();
      }
    } catch (error) {
      console.error('âŒ è‡ªåŠ¨ç”Ÿæˆæ¸¸å®¢IDå¤±è´¥:', error);
    }
  };

  const setupReauthCallback = () => {
    // æ³¨å†Œé‡æ–°è®¤è¯å›è°ƒ
    tokenValidationService.onReauthRequired(() => {
      console.log('ğŸ”„ æ˜¾ç¤ºé‡æ–°è®¤è¯å¼¹çª—');
      setReauthReason('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
      setShowReauthModal(true);
    });
  };

  const handleReauthSuccess = () => {
    console.log('âœ… é‡æ–°è®¤è¯æˆåŠŸ');
    setShowReauthModal(false);
  };

  const handleReauthClose = () => {
    console.log('âŒ ç”¨æˆ·å–æ¶ˆé‡æ–°è®¤è¯');
    setShowReauthModal(false);
  };

  const handleInitialLanguageComplete = () => {
    setShowInitialLanguageModal(false);
  };

  return (
    <AuthProvider>
      <LanguageProvider>
        <ShowListProvider>
          <VocabularyProvider>
            <MainLayout />
            <InitialLanguageModal
              visible={showInitialLanguageModal}
              onComplete={handleInitialLanguageComplete}
            />
            <ReauthModal
              visible={showReauthModal}
              onClose={handleReauthClose}
              onLoginSuccess={handleReauthSuccess}
              reason={reauthReason}
            />
          </VocabularyProvider>
        </ShowListProvider>
      </LanguageProvider>
    </AuthProvider>
  );
};

export default function App() {
  useEffect(() => {
    // è®¾ç½®éŸ³é¢‘æ¨¡å¼ï¼Œç¡®ä¿ iOS é™éŸ³æ‹¨ç‰‡ä¸‹ä¹Ÿèƒ½æ’­æ”¾
    Audio.setAudioModeAsync({
      allowsRecordingIOS: false,
      staysActiveInBackground: false,
      interruptionModeIOS: InterruptionModeIOS.DoNotMix,
      playsInSilentModeIOS: true, // å…³é”®è®¾ç½®
      shouldDuckAndroid: true,
      interruptionModeAndroid: InterruptionModeAndroid.DoNotMix,
      playThroughEarpieceAndroid: false,
    });
  }, []);

  return (
    <GestureHandlerRootView style={{ flex: 1 }}>
      <AppLanguageProvider>
        <AppContent />
      </AppLanguageProvider>
    </GestureHandlerRootView>
  );
} 