import React, { createContext, useContext, useState, ReactNode, useEffect } from 'react';
import { UserService } from '../services/userService';
import { unifiedSyncService } from '../services/unifiedSyncService';
import AsyncStorage from '@react-native-async-storage/async-storage';
import Logger from '../utils/logger';

// åˆ›å»ºé¡µé¢ä¸“ç”¨æ—¥å¿—å™¨
const logger = Logger.forPage('AuthContext');

interface UserInfo {
  id: string;
  nickname?: string;
  phone?: string;
  email?: string;
  avatar?: string;
  loginType?: 'wechat' | 'apple' | 'phone' | 'guest';
  createdAt?: string;
  updatedAt?: string;
  learningStats?: {
    level?: number;
    totalWords?: number;
    masteredWords?: number;
    learningDays?: number;
    currentStreak?: number;
    totalReviews?: number;
    accuracy?: number;
  };
}

interface AuthContextType {
  user: UserInfo | null;
  loginType: string | null;
  isAuthenticated: boolean;
  login: (userData: UserInfo, type: string) => Promise<void>;
  logout: () => Promise<void>;
  updateUser: (userData: Partial<UserInfo>) => void;
  getAuthToken: () => Promise<string | null>;
}

const AuthContext = createContext<AuthContextType | undefined>(undefined);

export const useAuth = () => {
  const ctx = useContext(AuthContext);
  if (!ctx) throw new Error('useAuth must be used within AuthProvider');
  return ctx;
};

export const AuthProvider = ({ children }: { children: ReactNode }) => {
  const [user, setUser] = useState<UserInfo | null>(null);
  const [loginType, setLoginType] = useState<string | null>(null);
  const [isAuthenticated, setIsAuthenticated] = useState(false);
  const userService = UserService.getInstance();

  // åˆå§‹åŒ–æ—¶åŠ è½½ç”¨æˆ·ä¿¡æ¯
  useEffect(() => {
    loadUserInfo();
  }, []);

  const loadUserInfo = async () => {
    try {
      logger.log('loadUserInfo å¼€å§‹', 'loadUserInfo');
      const userLoginInfo = await userService.getUserLoginInfo();
      if (userLoginInfo) {
        logger.log('æ‰¾åˆ°ç”¨æˆ·æ•°æ®', 'loadUserInfo');
        
        // éªŒè¯tokenæ˜¯å¦æœ‰æ•ˆ
        const token = await userService.getAuthToken();
        if (token) {
          // å¯¼å…¥tokenValidationService
          const { TokenValidationService } = await import('../services/tokenValidationService');
          const tokenValidationService = TokenValidationService.getInstance();
          const validation = await tokenValidationService.validateToken(token);
          
          if (validation.isValid) {
            logger.log('tokenéªŒè¯é€šè¿‡ï¼Œè®¾ç½®è®¤è¯çŠ¶æ€', 'loadUserInfo');
            setUser(userLoginInfo.userData);
            setLoginType(userLoginInfo.loginType);
            setIsAuthenticated(true);
          } else {
            logger.log('tokenéªŒè¯å¤±è´¥ï¼Œæ¸…é™¤æ— æ•ˆæ•°æ®', 'loadUserInfo');
            // tokenæ— æ•ˆï¼Œæ¸…é™¤æ•°æ®
            await userService.clearUserLoginInfo();
            setUser(null);
            setLoginType(null);
            setIsAuthenticated(false);
          }
        } else {
          logger.log('æ²¡æœ‰æ‰¾åˆ°tokenï¼Œæ¸…é™¤è®¤è¯çŠ¶æ€', 'loadUserInfo');
          setUser(null);
          setLoginType(null);
          setIsAuthenticated(false);
        }
      } else {
        logger.log('æ²¡æœ‰æ‰¾åˆ°ç”¨æˆ·æ•°æ®', 'loadUserInfo');
        
        // æ£€æŸ¥æ˜¯å¦æœ‰è‡ªåŠ¨ç”Ÿæˆçš„æ¸¸å®¢ID
        const autoGeneratedUserData = await AsyncStorage.getItem('userData');
        if (autoGeneratedUserData) {
          try {
            const parsedData = JSON.parse(autoGeneratedUserData);
            if (parsedData.isAutoGenerated && parsedData.loginType === 'guest') {
              logger.log('å‘ç°è‡ªåŠ¨ç”Ÿæˆçš„æ¸¸å®¢ID', 'loadUserInfo');
              setUser(parsedData);
              setLoginType('guest');
              setIsAuthenticated(false); // è‡ªåŠ¨ç”Ÿæˆçš„ç”¨æˆ·éœ€è¦æ‰‹åŠ¨ç™»å½•æ‰èƒ½è·å¾—token
            }
          } catch (error) {
            logger.error('è§£æè‡ªåŠ¨ç”Ÿæˆçš„ç”¨æˆ·æ•°æ®å¤±è´¥', 'loadUserInfo');
          }
        }
      }
    } catch (error) {
      logger.error('loadUserInfo å¤±è´¥', 'loadUserInfo');
    }
  };

  const login = async (userData: UserInfo, type: string) => {
    try {
      logger.log('login å¼€å§‹', 'login');
      await userService.saveUserLoginInfo(userData, type);
      logger.log('ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨å®Œæˆ', 'login');
      
      setUser(userData);
      setLoginType(type);
      setIsAuthenticated(true);
      
      logger.log('çŠ¶æ€æ›´æ–°å®Œæˆ', 'login');
      // æ–°å¢ï¼šç™»å½•ååŒæ­¥æœ¬åœ°å†å²åˆ°äº‘ç«¯
      await unifiedSyncService.addToSyncQueue({
        type: 'searchHistory',
        data: await AsyncStorage.getItem('searchHistory') || [],
        userId: userData.id,
        operation: 'update',
        priority: 'high'
      });
    } catch (error) {
      logger.error('login å¤±è´¥', 'login');
      throw error;
    }
  };

  const logout = async () => {
    try {
      await userService.clearUserLoginInfo();
      setUser(null);
      setLoginType(null);
      setIsAuthenticated(false);
    } catch (error) {
      console.error('ç™»å‡ºå¤±è´¥:', error);
    }
  };

  const updateUser = (userData: Partial<UserInfo>) => {
    if (user) {
      setUser({ ...user, ...userData });
    }
  };

  const getAuthToken = async (): Promise<string | null> => {
    try {
      console.log('ğŸ” [AuthContext] getAuthToken å¼€å§‹è°ƒç”¨...');
      const token = await userService.getAuthToken();
      console.log('ğŸ” [AuthContext] getAuthToken ç»“æœ:', token ? `${token.substring(0, 20)}...` : 'null');
      
      // å¦‚æœuserServiceè·å–å¤±è´¥ï¼Œå°è¯•ç›´æ¥ä»AsyncStorageè·å–
      if (!token) {
        console.log('ğŸ” [AuthContext] userServiceè·å–tokenå¤±è´¥ï¼Œå°è¯•ç›´æ¥ä»AsyncStorageè·å–...');
        try {
          const directToken = await AsyncStorage.getItem('authToken');
          console.log('ğŸ” [AuthContext] ç›´æ¥ä»AsyncStorageè·å–çš„token:', directToken ? `${directToken.substring(0, 20)}...` : 'null');
          return directToken;
        } catch (directError) {
          console.error('âŒ [AuthContext] ç›´æ¥ä»AsyncStorageè·å–tokenä¹Ÿå¤±è´¥:', directError);
        }
      }
      
      return token;
    } catch (error) {
      console.error('âŒ AuthContext getAuthToken å¤±è´¥:', error);
      return null;
    }
  };

  return (
    <AuthContext.Provider value={{ user, loginType, isAuthenticated, login, logout, updateUser, getAuthToken }}>
      {children}
    </AuthContext.Provider>
  );
}; 