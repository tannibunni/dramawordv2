# 🧪 苹果支付沙盒测试指南

## 📋 概述
本文档介绍如何在开发环境中设置和使用苹果支付沙盒测试账户，以安全地测试应用内购买功能。

## 🔧 环境配置

### 1. 开发环境构建
```bash
# 使用开发配置构建
eas build --platform ios --profile development

# 或使用脚本
./scripts/build-dev.sh
```

### 2. 环境变量
开发环境会自动设置以下环境变量：
- `EXPO_PUBLIC_ENVIRONMENT=development`
- `EXPO_PUBLIC_IAP_SANDBOX=true`
- `EXPO_PUBLIC_IAP_TEST_MODE=true`

## 🍎 沙盒测试账户设置

### 1. 创建沙盒测试账户
1. 登录 [Apple Developer](https://developer.apple.com)
2. 进入 "Certificates, Identifiers & Profiles"
3. 选择 "Users and Access" → "Sandbox Testers"
4. 点击 "+" 创建新的沙盒测试账户

### 2. 沙盒测试账户类型
- **真实账户**：使用真实的Apple ID
- **专用测试账户**：专门用于测试的账户

### 3. 测试账户配置
- 国家/地区：选择支持的应用内购买地区
- 支付方式：使用测试信用卡信息
- 年龄：确保符合应用要求

## 💳 测试支付流程

### 1. 安装开发版本
- 使用EAS构建的开发版本
- 确保设备已登录沙盒测试账户

### 2. 测试购买流程
1. 打开应用
2. 进入订阅页面
3. 选择订阅计划
4. 点击购买按钮
5. 使用沙盒测试账户确认购买

### 3. 验证购买结果
- 检查订阅状态更新
- 验证功能解锁
- 查看购买历史

## 🚨 重要注意事项

### 1. 沙盒限制
- 不会产生真实费用
- 购买在沙盒环境中有效
- 每次测试需要重新购买

### 2. 测试最佳实践
- 使用专门的测试设备
- 定期清理测试数据
- 测试各种支付场景

### 3. 常见问题
- **购买失败**：检查沙盒账户状态
- **订阅不生效**：重启应用或重新登录
- **网络错误**：检查网络连接

## 🔍 调试和日志

### 1. 控制台日志
开发环境会输出详细的支付日志：
```
[IAPService] 🧪 开发环境 - 使用沙盒模式
[IAPService] 📦 收到购买更新: {...}
[IAPService] ✅ 购买验证成功
```

### 2. 错误处理
- 网络错误：自动重试
- 验证失败：回退到模拟模式
- 沙盒错误：提供详细错误信息

## 📱 测试设备要求

### 1. iOS设备
- iOS 13.0 或更高版本
- 已登录沙盒测试账户
- 网络连接正常

### 2. 开发环境
- Expo开发客户端
- 正确的环境配置
- 沙盒模式启用

## 🎯 测试检查清单

- [ ] 沙盒测试账户已创建
- [ ] 开发版本已安装
- [ ] 设备已登录测试账户
- [ ] 网络连接正常
- [ ] 支付流程测试完成
- [ ] 订阅状态验证通过
- [ ] 功能解锁测试完成

## 📞 技术支持

如果遇到问题，请检查：
1. 沙盒账户状态
2. 网络连接
3. 应用日志
4. 设备设置

---

**注意**：沙盒测试仅用于开发环境，生产环境必须使用真实的支付流程。
