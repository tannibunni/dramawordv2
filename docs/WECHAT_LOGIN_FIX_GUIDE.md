# å¾®ä¿¡ç™»å½•é—®é¢˜ä¿®å¤æŒ‡å—

## ğŸš¨ é—®é¢˜æè¿°

å¾®ä¿¡ç™»å½•æ²¡æœ‰å¼¹å‡ºå¾®ä¿¡æˆæƒå¼¹çª—ï¼Œè€Œæ˜¯ç›´æ¥è¿›å…¥æ¨¡æ‹Ÿç™»å½•æˆåŠŸçš„ç•Œé¢ã€‚

## ğŸ” é—®é¢˜åˆ†æ

### **æ ¹æœ¬åŸå› **
1. **æµ‹è¯•å‡½æ•°è°ƒç”¨**: å¾®ä¿¡ç™»å½•è°ƒç”¨çš„æ˜¯ `testLogin('wechat')` å‡½æ•°ï¼Œè¿™æ˜¯ä¸€ä¸ªæµ‹è¯•å‡½æ•°
2. **æ¨¡æ‹Ÿç™»å½•**: æµ‹è¯•å‡½æ•°ç›´æ¥è°ƒç”¨åç«¯æ³¨å†Œ APIï¼Œè·³è¿‡çœŸæ­£çš„å¾®ä¿¡æˆæƒæµç¨‹
3. **å¼€å‘ç¯å¢ƒ**: ä½¿ç”¨ `MockWechatSDK` æ¨¡æ‹Ÿå¾®ä¿¡æˆæƒï¼Œè€Œä¸æ˜¯çœŸå®çš„å¾®ä¿¡ SDK

### **å·²ä¿®å¤çš„é—®é¢˜**
- âœ… å·²å°†å¾®ä¿¡ç™»å½•æ”¹ä¸ºè°ƒç”¨ `WechatService.performLogin()` å‡½æ•°
- âœ… ç°åœ¨ä¼šæ‰§è¡ŒçœŸæ­£çš„å¾®ä¿¡æˆæƒæµç¨‹

## âœ… è§£å†³æ–¹æ¡ˆ

### **æ­¥éª¤ 1: æ£€æŸ¥å¾®ä¿¡ç¯å¢ƒå˜é‡é…ç½®**

1. **ç™»å½• Render æ§åˆ¶å°**
   - è®¿é—®ï¼šhttps://dashboard.render.com
   - æ‰¾åˆ° `dramaword-api` æœåŠ¡

2. **æ£€æŸ¥å¾®ä¿¡ç¯å¢ƒå˜é‡**
   - è¿›å…¥ `Environment` æ ‡ç­¾é¡µ
   - ç¡®ä¿ä»¥ä¸‹ç¯å¢ƒå˜é‡å·²è®¾ç½®ï¼š
     - `WECHAT_APP_ID = wxa225945508659eb8`
     - `WECHAT_APP_SECRET = ä½ çš„å¾®ä¿¡åº”ç”¨å¯†é’¥`
     - `WECHAT_BUNDLE_ID = com.tannibunni.dramawordmobile`

3. **æ›´æ–°ç¯å¢ƒå˜é‡**
   - å¦‚æœç¯å¢ƒå˜é‡ä¸æ­£ç¡®ï¼Œæ›´æ–°åä¿å­˜
   - é‡æ–°éƒ¨ç½²åç«¯æœåŠ¡

### **æ­¥éª¤ 2: å¾®ä¿¡å¼€æ”¾å¹³å°é…ç½®**

1. **ç™»å½•å¾®ä¿¡å¼€æ”¾å¹³å°**
   - è®¿é—®ï¼šhttps://open.weixin.qq.com/
   - ä½¿ç”¨æ‚¨çš„å¾®ä¿¡å¼€å‘è€…è´¦æˆ·ç™»å½•

2. **æ£€æŸ¥åº”ç”¨é…ç½®**
   - æ‰¾åˆ°åº”ç”¨ IDï¼š`wxa225945508659eb8`
   - ç¡®è®¤åº”ç”¨çŠ¶æ€ä¸º"å·²ä¸Šçº¿"
   - æ£€æŸ¥åº”ç”¨æƒé™æ˜¯å¦åŒ…å«"å¾®ä¿¡ç™»å½•"

3. **é…ç½®æˆæƒå›è°ƒåŸŸå**
   - åœ¨åº”ç”¨é…ç½®ä¸­æ·»åŠ æˆæƒå›è°ƒåŸŸå
   - ç¡®ä¿åŒ…å«æ‚¨çš„åº”ç”¨åŸŸå

### **æ­¥éª¤ 3: æµ‹è¯•å¾®ä¿¡ç™»å½•åŠŸèƒ½**

1. **é‡æ–°æ„å»ºåº”ç”¨**
   ```bash
   cd apps/mobile
   npx expo start --clear
   ```

2. **æµ‹è¯•å¾®ä¿¡ç™»å½•**
   - å¯åŠ¨åº”ç”¨
   - è¿›å…¥ Profile é¡µé¢
   - ç‚¹å‡»"ç™»å½•"æŒ‰é’®
   - é€‰æ‹©"ä½¿ç”¨å¾®ä¿¡ç™»å½•"
   - åº”è¯¥ä¼šå¼¹å‡ºå¾®ä¿¡æˆæƒå¼¹çª—

## ğŸ”§ æŠ€æœ¯å®ç°

### **å¾®ä¿¡ç™»å½•æµç¨‹**

```typescript
// ä¿®å¤åçš„å¾®ä¿¡ç™»å½•æµç¨‹
const handleWechatLogin = async () => {
  try {
    setLoading(true);
    
    console.log('ğŸ’¬ å¼€å§‹å¾®ä¿¡ç™»å½•æµç¨‹...');
    
    // è°ƒç”¨çœŸæ­£çš„å¾®ä¿¡ç™»å½•æµç¨‹
    const { WechatService } = require('../../services/wechatService');
    const result = await WechatService.performLogin();
    
    if (result.success && result.data) {
      // ä¿å­˜ç”¨æˆ·ä¿¡æ¯åˆ°æœ¬åœ°å­˜å‚¨
      const userData = {
        id: result.data.user.id,
        nickname: result.data.user.nickname,
        avatar: result.data.user.avatar,
        loginType: 'wechat',
        token: result.data.token,
      };
      
      // æ¸…é™¤æ—§ç¼“å­˜ï¼Œç¡®ä¿æ–°ç”¨æˆ·çœ‹åˆ°æ­£ç¡®çš„æ•°æ®
      await clearAllSharedData();
      
      onLoginSuccess(userData);
    } else {
      throw new Error(result.message || 'å¾®ä¿¡ç™»å½•å¤±è´¥');
    }
  } catch (error: any) {
    console.error('âŒ å¾®ä¿¡ç™»å½•å¤±è´¥:', error);
    
    if (error.message.includes('è¯·å…ˆå®‰è£…å¾®ä¿¡åº”ç”¨')) {
      Alert.alert('æç¤º', 'è¯·å…ˆå®‰è£…å¾®ä¿¡åº”ç”¨');
    } else if (error.message.includes('å¾®ä¿¡SDKæ³¨å†Œå¤±è´¥')) {
      Alert.alert('ç™»å½•å¤±è´¥', 'å¾®ä¿¡SDKåˆå§‹åŒ–å¤±è´¥ï¼Œè¯·é‡è¯•');
    } else {
      Alert.alert('ç™»å½•å¤±è´¥', error instanceof Error ? error.message : 'å¾®ä¿¡ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•');
    }
  } finally {
    setLoading(false);
  }
};
```

### **å¾®ä¿¡ SDK é…ç½®**

```typescript
// å¼€å‘ç¯å¢ƒä½¿ç”¨æ¨¡æ‹Ÿ SDKï¼Œç”Ÿäº§ç¯å¢ƒä½¿ç”¨çœŸå® SDK
const WechatSDK: WechatSDKInterface = __DEV__ ? new MockWechatSDK() : new RealWechatSDK();

// çœŸå®çš„å¾®ä¿¡ SDK å®ç°
class RealWechatSDK implements WechatSDKInterface {
  private appId: string = 'wxa225945508659eb8';
  private universalLink: string = 'https://dramaword.com/app/';

  async sendAuthRequest(scope: string, state: string): Promise<{ code: string; state: string }> {
    try {
      const { Wechat } = require('react-native-wechat-lib');
      const result = await Wechat.sendAuthRequest(scope, state);
      console.log('å¾®ä¿¡æˆæƒè¯·æ±‚ç»“æœ:', result);
      return result;
    } catch (error) {
      console.error('å¾®ä¿¡æˆæƒè¯·æ±‚å¤±è´¥:', error);
      throw error;
    }
  }
}
```

## ğŸ§ª æµ‹è¯•éªŒè¯

### **è‡ªåŠ¨åŒ–æµ‹è¯•**
è¿è¡Œä»¥ä¸‹è„šæœ¬éªŒè¯é…ç½®ï¼š
```bash
# æ£€æµ‹å¾®ä¿¡ç™»å½•åŠŸèƒ½
node scripts/test-wechat-login-feasibility.js
```

### **æ‰‹åŠ¨æµ‹è¯•æ­¥éª¤**
1. å¯åŠ¨åº”ç”¨
2. è¿›å…¥ Profile é¡µé¢
3. ç‚¹å‡»"ç™»å½•"æŒ‰é’®
4. é€‰æ‹©"ä½¿ç”¨å¾®ä¿¡ç™»å½•"
5. åº”è¯¥å¼¹å‡ºå¾®ä¿¡æˆæƒå¼¹çª—
6. å®Œæˆå¾®ä¿¡æˆæƒ
7. æ£€æŸ¥æ˜¯å¦æˆåŠŸç™»å½•

## ğŸ“‹ é…ç½®æ£€æŸ¥æ¸…å•

### **âœ… å·²ç¡®è®¤æ­£ç¡®çš„é…ç½®**

1. **å¾®ä¿¡ App ID**
   - æ–‡ä»¶ï¼š`apps/mobile/src/services/wechatService.ts`
   - å€¼ï¼š`wxa225945508659eb8`

2. **å¾®ä¿¡é…ç½®æ–‡ä»¶**
   - æ–‡ä»¶ï¼š`services/api/src/config/wechat.ts`
   - åŒ…å«å¿…è¦çš„é…ç½®é¡¹

3. **ç¯å¢ƒå˜é‡æ¨¡æ¿**
   - æ–‡ä»¶ï¼š`services/api/env.template`
   - åŒ…å«å¾®ä¿¡é…ç½®

4. **å¾®ä¿¡ SDK é…ç½®**
   - æ–‡ä»¶ï¼š`apps/mobile/src/services/wechatSDK.ts`
   - å¼€å‘ç¯å¢ƒä½¿ç”¨æ¨¡æ‹Ÿ SDK

### **âš ï¸ éœ€è¦æ£€æŸ¥çš„é…ç½®**

1. **Render ç¯å¢ƒå˜é‡**
   - ä½ç½®ï¼šRender æ§åˆ¶å°
   - å˜é‡ï¼š`WECHAT_APP_ID`, `WECHAT_APP_SECRET`, `WECHAT_BUNDLE_ID`

2. **å¾®ä¿¡å¼€æ”¾å¹³å°**
   - App IDï¼š`wxa225945508659eb8`
   - åº”ç”¨çŠ¶æ€ï¼šå·²ä¸Šçº¿
   - æˆæƒå›è°ƒåŸŸåï¼šå·²é…ç½®

## ğŸ¯ é¢„æœŸç»“æœ

ä¿®å¤æˆåŠŸåï¼š
- âœ… ç‚¹å‡»å¾®ä¿¡ç™»å½•æŒ‰é’®ä¼šå¼¹å‡ºå¾®ä¿¡æˆæƒå¼¹çª—
- âœ… ç”¨æˆ·å¯ä»¥åœ¨å¾®ä¿¡ä¸­å®Œæˆæˆæƒ
- âœ… æˆæƒæˆåŠŸåè¿”å›åº”ç”¨å¹¶å®Œæˆç™»å½•
- âœ… ç™»å½•åç”¨æˆ·ä¿¡æ¯æ­£ç¡®æ˜¾ç¤º
- âœ… ç™»å½•çŠ¶æ€æ­£ç¡®ä¿å­˜

## ğŸ“Š å½±å“è¯„ä¼°

### **æ­£é¢å½±å“**
- âœ… æ¢å¤äº†çœŸæ­£çš„å¾®ä¿¡æˆæƒæµç¨‹
- âœ… ç”¨æˆ·ä½“éªŒæ›´åŠ çœŸå®
- âœ… ç¬¦åˆå¾®ä¿¡ç™»å½•æ ‡å‡†æµç¨‹

### **æ³¨æ„äº‹é¡¹**
- éœ€è¦ç¡®ä¿å¾®ä¿¡åº”ç”¨å·²å®‰è£…
- éœ€è¦æ­£ç¡®çš„å¾®ä¿¡å¼€æ”¾å¹³å°é…ç½®
- å¼€å‘ç¯å¢ƒä½¿ç”¨æ¨¡æ‹Ÿ SDKï¼Œç”Ÿäº§ç¯å¢ƒéœ€è¦çœŸå® SDK

## ğŸš€ åç»­ä¼˜åŒ–å»ºè®®

### **çŸ­æœŸä¼˜åŒ–**
1. æ·»åŠ å¾®ä¿¡ç™»å½•å¤±è´¥é‡è¯•æœºåˆ¶
2. ä¼˜åŒ–å¾®ä¿¡æˆæƒæµç¨‹çš„ç”¨æˆ·ä½“éªŒ
3. å¢åŠ å¾®ä¿¡ç™»å½•çŠ¶æ€ç¼“å­˜

### **é•¿æœŸè§„åˆ’**
1. æ”¯æŒå¾®ä¿¡å°ç¨‹åºç™»å½•
2. å®ç°å¾®ä¿¡åˆ†äº«åŠŸèƒ½
3. æ·»åŠ å¾®ä¿¡æ”¯ä»˜åŠŸèƒ½

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœæŒ‰ç…§ä»¥ä¸Šæ­¥éª¤ä»ç„¶æ— æ³•è§£å†³é—®é¢˜ï¼Œè¯·ï¼š

1. **æ”¶é›†é”™è¯¯ä¿¡æ¯**
   - å®Œæ•´çš„é”™è¯¯æ—¥å¿—
   - å¾®ä¿¡æˆæƒæµç¨‹æ—¥å¿—
   - åç«¯æœåŠ¡æ—¥å¿—

2. **æ£€æŸ¥é…ç½®çŠ¶æ€**
   - è¿è¡Œå¾®ä¿¡ç™»å½•æ£€æµ‹è„šæœ¬
   - ç¡®è®¤æ‰€æœ‰é…ç½®é¡¹æ­£ç¡®

3. **è”ç³»å¼€å‘å›¢é˜Ÿ**
   - æä¾›è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
   - è¯´æ˜å·²å°è¯•çš„è§£å†³æ­¥éª¤

---

**æœ€åæ›´æ–°**: 2025-08-01
**çŠ¶æ€**: å·²ä¿®å¤
**ä¼˜å…ˆçº§**: é«˜ 