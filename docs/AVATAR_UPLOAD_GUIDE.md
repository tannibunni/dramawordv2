# 用户头像上传和昵称编辑功能指南

## 📋 功能概述

剧词记应用已完整实现了用户头像上传和昵称编辑功能，包括：

- ✅ 头像拍照上传
- ✅ 从相册选择头像
- ✅ 昵称编辑（最多30个字符）
- ✅ 实时预览
- ✅ 自动保存到服务器
- ✅ 多平台头像显示

## 🎯 功能特性

### 头像管理
- **多种选择方式**：支持拍照和从相册选择
- **图片处理**：自动裁剪为1:1比例，压缩质量0.8
- **文件限制**：最大5MB，支持JPEG、PNG、WebP格式
- **智能存储**：上传到服务器并生成唯一文件名
- **优先级显示**：自定义头像 > 登录类型默认头像 > 游客头像

### 昵称编辑
- **字符限制**：最多30个字符
- **实时计数**：显示当前字符数/最大字符数
- **验证提示**：空昵称和超长昵称的友好提示
- **即时更新**：保存后立即在界面中显示

## 🔧 技术实现

### 后端架构
```
services/api/
├── src/
│   ├── middleware/upload.ts          # 文件上传中间件
│   ├── controllers/userController.ts # 用户控制器
│   ├── routes/user.ts               # 用户路由
│   └── index.ts                     # 静态文件服务
├── uploads/avatars/                 # 头像存储目录
└── env.template                     # 环境变量配置
```

### 前端架构
```
apps/mobile/src/
├── components/profile/
│   └── EditProfileModal.tsx         # 编辑资料模态框
├── screens/Profile/
│   └── ProfileScreen.tsx            # 个人资料页面
├── services/
│   └── userService.ts               # 用户服务
└── constants/
    └── config.ts                    # API配置
```

## 🚀 使用方法

### 1. 访问个人资料
- 打开应用，进入"个人资料"页面
- 点击右上角的编辑按钮（铅笔图标）

### 2. 编辑头像
- 点击头像区域
- 选择"拍照"或"从相册选择"
- 调整图片位置和大小
- 确认选择

### 3. 编辑昵称
- 在昵称输入框中输入新昵称
- 实时查看字符计数
- 确保昵称不为空且不超过30个字符

### 4. 保存更改
- 点击"保存"按钮
- 等待上传和保存完成
- 查看成功提示

## 📱 界面说明

### 编辑模态框
- **头部**：取消按钮、标题、保存按钮
- **头像区域**：圆形头像显示、编辑图标、提示文字
- **昵称区域**：输入框、字符计数、占位符提示

### 状态指示
- **上传中**：头像区域显示加载动画
- **保存中**：保存按钮显示加载动画
- **成功**：显示成功提示并自动关闭
- **错误**：显示错误提示，可重试

## 🔍 调试信息

应用会在控制台输出详细的调试信息：

```
🔍 getUserAvatar 调试信息: { user, loginType, isAuthenticated }
📤 开始上传头像...
✅ 头像上传成功: { avatar: "https://..." }
📝 更新用户资料: { nickname: "新昵称", avatar: "https://..." }
✅ 用户资料更新成功
```

## ⚙️ 配置说明

### 环境变量
```bash
# services/api/.env
API_BASE_URL=https://your-api-domain.com
PORT=3001
```

### 前端配置
```typescript
// apps/mobile/src/constants/config.ts
export const API_BASE_URL = 'https://your-api-domain.com/api';
```

## 🛠️ 故障排除

### 常见问题

1. **头像上传失败**
   - 检查网络连接
   - 确认文件大小不超过5MB
   - 验证文件格式为图片

2. **昵称保存失败**
   - 确保昵称不为空
   - 检查字符数不超过30个
   - 验证用户登录状态

3. **头像显示异常**
   - 检查API_BASE_URL配置
   - 确认静态文件服务正常
   - 验证文件权限设置

### 调试步骤
1. 运行测试脚本：`node scripts/test-avatar-upload.js`
2. 检查后端日志
3. 查看前端控制台输出
4. 验证API响应状态

## 📊 性能优化

- **图片压缩**：上传前自动压缩到0.8质量
- **缓存策略**：头像URL缓存30分钟
- **懒加载**：头像按需加载
- **错误重试**：网络错误自动重试3次

## 🔐 安全考虑

- **文件类型验证**：只允许图片文件
- **文件大小限制**：最大5MB
- **用户认证**：需要登录才能编辑
- **路径安全**：使用唯一文件名避免冲突

## 📈 未来改进

- [ ] 支持头像裁剪和滤镜
- [ ] 添加头像预览功能
- [ ] 支持批量头像管理
- [ ] 增加头像历史记录
- [ ] 优化上传进度显示

---

**最后更新**：2024年12月
**版本**：1.0.0
**维护者**：Tanny 